rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- FUNCIONES DE AYUDA (HELPERS) ---

    // Verificar si el usuario está autenticado
    function isAuthenticated() {
      return request.auth != null;
    }

    // Obtener el rol del usuario desde su documento
    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.rol;
    }

    // Verificar roles específicos
    function isAdmin() {
      return isAuthenticated() && getUserRole() == 'administrador';
    }

    function isGerente() {
      return isAuthenticated() && getUserRole() == 'gerente';
    }
    
    function isPanadero() {
      return isAuthenticated() && getUserRole() == 'panadero';
    }
    
    function isTransportista() {
      return isAuthenticated() && getUserRole() == 'transportista';
    }
    
    function isMonitor() {
      return isAuthenticated() && getUserRole() == 'monitor';
    }

    function isSucursal() {
      return isAuthenticated() && getUserRole() == 'sucursal';
    }

    // Verificar si es el propio usuario (para editar su perfil)
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // --- REGLAS POR COLECCIÓN ---

    // 1. Colección de USUARIOS
    match /users/{userId} {
      // Cualquiera autenticado puede leer (necesario para verificar roles)
      allow read: if isAuthenticated();
      
      // Solo el admin puede crear/borrar usuarios directamente (aunque se crean al login)
      allow create: if isAuthenticated(); // Permitir creación inicial al registrarse
      
      // Actualización:
      // - Admin: Puede cambiar todo (incluyendo roles)
      // - Usuario: Puede cambiar sus datos PERO NO SU ROL
      allow update: if isAdmin() 
                    || (isOwner(userId) && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['rol']));
    }

    // 2. Colección de PRODUCTOS
    match /products/{productId} {
      // Lectura pública para cualquier usuario autenticado
      allow read: if isAuthenticated();
      
      // Escritura (Crear, Editar, Borrar): Solo Admin y Gerente
      allow write: if isAdmin() || isGerente();
    }

    // 3. Colección de PEDIDOS (Orders)
    match /orders/{orderId} {
      // LECTURA:
      // - Admin, Gerente, Panadero, Transportista, Monitor: Ven TODO
      // - Sucursal/Cliente: Solo ven SUS propios pedidos
      allow read: if isAdmin() || isGerente() || isPanadero() || isTransportista() || isMonitor()
                  || (isAuthenticated() && resource.data.userId == request.auth.uid);

      // CREACIÓN:
      // - Admin, Gerente, Sucursal, Cliente: Pueden crear
      // - Panadero, Transportista, Monitor: NO crean pedidos
      allow create: if isAdmin() || isGerente() || isSucursal() || isAuthenticated(); // Cliente es default

      // ACTUALIZACIÓN (Cambios de estado):
      // - Admin/Gerente: Control total
      // - Panadero: Puede cambiar estado si está asignado a producción (o lógica futura)
      // - Transportista: Puede cambiar estado a entregado/en ruta
      allow update: if isAdmin() || isGerente() || isPanadero() || isTransportista();
      
      // ELIMINACIÓN:
      // - Solo Admin
      allow delete: if isAdmin();
    }
  }
}
